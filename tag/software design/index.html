<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" type="text/css" href="http://www.quantisan.com/theme/css/style.css">
    <link rel="stylesheet" type="text/css" href="http://www.quantisan.com/theme/css/pygments.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:800,400,300|Inconsolata' rel='stylesheet' type='text/css'>
	<link href="http://www.quantisan.com/" type="application/atom+xml" rel="alternate" title="Quantitative Artisan ATOM Feed" />


        <title>Quantitative Artisan - software design</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Paul Lam">
</head>

<body>
    <section id="navbar">
        <div class="user_meta">
            <h1 id="user"><a href="http://www.quantisan.com" class="">Paul Lam</a></h1>
            <h2>Data. Engineering. Startup.</h2>
        </div>
        <div class="nav-button">
            <ul>
                                    <li><a href="http://www.quantisan.com/about/">About</a></li>
                            <li><a href="mailto:paul@quantisan.com">Email</a></li>
                            <li><a href="http://www.twitter.com/Quantisan">Twitter</a></li>
                            <li><a href="http://www.github.com/Quantisan">Github</a></li>
                            <li><a href="http://www.linkedin.com/in/paullam">LinkedIn</a></li>
                            <li><a href="http://feeds.feedburner.com/Quantisan">Subscribe</a></li>
             </ul>
         </div>
     </section>

     <section id="sidebar">
        <img src="/images/profile_circle.png" id="logo" alt="logo">

        <div class="user_meta">
            <h1 id="user"><a href="http://www.quantisan.com" class="">Paul Lam</a></h1>
            <h2>Data. Engineering. Startup.</h2>
            <ul>
                        <li><a href="http://www.quantisan.com/about/">About</a></li>
                        <li><a href="mailto:paul@quantisan.com">Email</a></li>
                        <li><a href="http://www.twitter.com/Quantisan">Twitter</a></li>
                        <li><a href="http://www.github.com/Quantisan">Github</a></li>
                        <li><a href="http://www.linkedin.com/in/paullam">LinkedIn</a></li>
                        <li><a href="http://feeds.feedburner.com/Quantisan">Subscribe</a></li>
            </ul>
        </div>
        <footer>
            <address>
                Powered by <a href='http://docs.getpelican.com/en/latest/'>Pelican</a>,
                <a href='https://github.com/jamescooke/pelican-svbtle#readme'>theme info</a>.
            </address>
        </footer>
    </section>

    <section id="posts">
	
        <article class='listed'>
            <h1 class="title">
                <a href="http://www.quantisan.com/eureka-moment-on-design-patterns-for-functional-programming/" rel='bookmark'>Eureka moment on design patterns for functional programming</a>
            </h1>
            <div class="article-content"> <p>Understanding design patterns for object-oriented programming made my
life easier as a Java programmer. So I have been looking for a
comparable book for functional programming ever since my sojourn into
this age-old paradigm. It looks as though <a href="http://stackoverflow.com/questions/2930277/functional-programming-equivalent-of-design-patterns-book">I'm not the only one
looking</a> too. But the thing is, I think I've just had a revelation of
sort.</p>
<p>There is one and only one guideline to designing functional
architectures -- Keep it simple. Simple as in keeping your functions
having a single purpose only. Simple as in work with the data directly and
don't conjure unnecessary intermediaries. Simple, as elaborated by Rich
Hickey in his talk, <a href="http://www.infoq.com/presentations/Simple-Made-Easy">Simple Made Easy</a>. Much of this is conveyed in Bloch's Effective Java:</p>
<div class="highlight"><pre><span class="n">item</span> <span class="err">\#</span><span class="mi">5</span> <span class="err">\–</span> <span class="n">Avoid</span> <span class="n">creating</span> <span class="n">unnecessary</span> <span class="n">objects</span>
<span class="n">item</span> <span class="err">\#</span><span class="mi">13</span> <span class="err">\–</span> <span class="n">minimize</span> <span class="n">accessibility</span> <span class="n">of</span> <span class="n">classes</span> <span class="n">and</span> <span class="n">members</span>
</pre></div>


<p>, for examples.</p>
<p>As <a href="http://stackoverflow.com/questions/2930277/functional-programming-equivalent-of-design-patterns-book/2930452#2930452">Majewski said in a stackoverflow reply</a> (Update 2013 – question no longer available on stackoverflow),</p>
<div class="highlight"><pre><span class="n">The</span> <span class="n">patterns</span> <span class="n">movement</span> <span class="n">started</span> <span class="n">because</span> <span class="n">object</span><span class="o">-</span><span class="n">oriented</span> <span class="n">programming</span> 
<span class="n">was</span> <span class="n">often</span> <span class="n">turning</span> <span class="n">into</span> <span class="n">spaghetti</span> <span class="n">objects</span> <span class="p">...</span> <span class="n">Functional</span> <span class="n">programming</span> 
<span class="n">is</span> <span class="n">a</span> <span class="k">restricted</span> <span class="n">style</span> <span class="n">of</span> <span class="n">programming</span><span class="p">,</span> <span class="n">so</span> <span class="n">it</span> <span class="n">didn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">need</span> <span class="n">to</span> <span class="n">grow</span> <span class="n">a</span> <span class="n">set</span>
<span class="n">of</span> <span class="k">restricted</span> <span class="n">conventions</span> <span class="n">to</span> <span class="n">limit</span> <span class="n">the</span> <span class="n">chaos</span><span class="p">.</span>
</pre></div>


<p>As such, there is no design pattern book for functional programming. I didn't get that earlier this year. But something clicked recently. During the past few months, I've been doing some <a href="http://www.quantisan.com/ive-quit-my-day-job-and-moved-to-the-uk-to-do-this-full-time/">consulting and open source projects</a> solving algorithmic problems with Clojure.</p>
<p>One of the problems in a project that I was faced with this week is calculating the occurrence of each distinctive element within a list of elements. Say we have a list, <code>coll = ("orange", "bottle", "coke", "bottle")</code>. The output would be something like <code>[("orange", "bottle", "coke") (1 2 1)]</code> </p>
<p>This is my first solution.</p>
<div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">eval-decompose</span>
  <span class="p">[</span><span class="nv">coll</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">super-d</span>  <span class="p">(</span><span class="nb">distinct </span><span class="nv">coll</span><span class="p">)</span>
        <span class="nv">freqs</span>    <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">ps</span>  <span class="p">[]</span>
                        <span class="nv">d</span>   <span class="nv">super-d</span><span class="p">]</span>
                   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq </span><span class="nv">d</span><span class="p">)</span>
                     <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">c</span>  <span class="p">(</span><span class="nb">count </span><span class="p">(</span><span class="nb">filter </span><span class="p">(</span><span class="nb">partial = </span><span class="p">(</span><span class="nb">first </span><span class="nv">d</span><span class="p">))</span> <span class="nv">coll</span><span class="p">))]</span>
                       <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">ps</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">d</span><span class="p">)))</span>
                     <span class="nv">ps</span><span class="p">))]</span>
    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">vector </span><span class="nv">%1</span> <span class="nv">%2</span><span class="p">)</span> <span class="nv">super-d</span> <span class="nv">freqs</span><span class="p">)))</span>
</pre></div>


<p>The specs are not exactly as I described but the concept remains. What I
did is to use tail calls (it's supposed to be fast, isn't it?) to
aggregate each counter to produce a vector of counts. Then I map each
pair of fragment with its corresponding count to generate a final output
collection. Sounds overly complicated, doesn't it?</p>
<p>This is the first warning of a bad functional design. For a collection of 30,000 items,
this function took 11 minutes to compute on my notebook. This looks like
a good place to exploit the parallel nature of this problem.</p>
<p>Specifically, the counting of each fragment is independent of other
fragments. Thus, there's no need for the program to wait for one
fragment to finish to process the next. I simplified the program to
remove this inherent assumption of procedural processing. Here is the
gist of the refactored code where each function only does one job. Since
the processing are modularised, I can parallelize the algorithm easily
with the use of pmap instead of map on the last line as shown below.</p>
<div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">match-count</span>
<span class="s">&quot; Given key, k, returns number of occurrences of k in collection, coll.</span>
<span class="s">&quot;</span>
  <span class="p">[</span><span class="nv">k</span> <span class="nv">coll</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">match?</span>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">i</span> <span class="nv">x</span><span class="p">]</span>
                  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">k</span> <span class="nv">x</span><span class="p">)</span>   <span class="c1">;; closure on k</span>
                    <span class="p">(</span><span class="nb">inc </span><span class="nv">i</span><span class="p">)</span>
                    <span class="nv">i</span><span class="p">))]</span>
    <span class="p">(</span><span class="nb">reduce </span><span class="nv">match?</span> <span class="mi">0</span> <span class="nv">coll</span><span class="p">)))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">calc-counts</span>
<span class="s">&quot; Returns a list of counts for the occurrences of each key of keys, ks,</span>
<span class="s">  within the collection, coll.</span>
<span class="s">&quot;</span>
  <span class="p">[</span><span class="nv">ks</span> <span class="nv">coll</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">pmap</span> <span class="o">#</span><span class="p">(</span><span class="nf">match-count</span> <span class="nv">%</span> <span class="nv">coll</span><span class="p">)</span> <span class="nv">ks</span><span class="p">))</span>
</pre></div>


<p>I've split the first function into 3 functions (2 shown here). As Hickey
said in his talk, simplifying can often produce more, not less,
functions. Yet, the program is not only easier to read and runs in less
than a minute. An order of magnitude faster! There are still lots for me
to learn. I want to find more challenging projects to push my own
limits. But rather than solving arbitrary problems, I prefer to tackle
real-world challenges. So if you know of anyone that can benefit from
collaborating with a functional developer to build robust and scalable
software, please pass along <a href="mailto:paul@quantisan.com">my contact</a>.</p>
<p>Follow up: Kevin Lynagh showed me three better ways of doing this in a follow-up post – <a href="/algorithmic-ownage/">Algorithmimc ownage</a>. Humbled.</p> </div>
            <div class="abbr published">
                Posted  <a href='http://www.quantisan.com/eureka-moment-on-design-patterns-for-functional-programming/' title='2011-10-25T15:28:00'>25 October 2011</a> in <a href="http://www.quantisan.com/category/computing/">computing</a>.              
            </div>
        </article>
        <article class='listed'>
            <h1 class="title">
                <a href="http://www.quantisan.com/software-design-trading-development-process-and-ikea/" rel='bookmark'>Software design, trading development process, and Ikea</a>
            </h1>
            <div class="article-content"> <p>I spent a few months between 2010 and 2011 not on the market, not on
coming up with new strategies, but on developing a software framework
for my trading system. For my trading strategy development, I make use
of a continuous systems development life cycle process from the
engineering realm. Starting from planning, to analysis, to design, to
implementation, to maintenance, and finally, back to planning, and so on
for each and every new concept that I have. (see <a href="http://www.wired.com/epicenter/2011/04/in-praise-of-failure/all/1">Sir James Dyson's
guest column on Wired</a>) Imagine that if you need to write a new
strategy file for each and every idea and for each of its design
iteration. Pretty soon you'll have many strategy files and a lot of
boilerplate codes. What if you found a bug or figured out some
enhancements to a particular component of your strategy? Then you'll
have to sift through all those files and make the changes to all those
relevant codes to make the update across the board. Hopefully, this
isn't the approach you're taking. Yet, a few trading API that I have
used before inherently encourage or even limit you (<a href="http://www.quantisan.com/why-i-am-not-a-big-fan-of-mql4-or-trading-platform-scripting/">EasyLanguage and
MQL4</a>) to this archaic procedural programming paradigm. Luckily, Java
is an object-oriented programming language. However, it is only as
object-oriented as you make it to be. JForex, <a href="http://www.quantisan.com/tag/jforex">the trading API that I
use</a>, actually runs on <a href="http://www.quantisan.com/more-trouble-with-jforex-iindicators/">the edge of breaking this
object-orientedness</a> as I have recently lamented. The bad news for the
beginning developer is that practically every published strategy which I
have seen or <a href="http://www.quantisan.com/tag/source-code/">guilty of posting myself</a> are illustrations of what not
to do with software design. In that there's none in it whatsoever. Think
of common published strategies like the Ikea mini-model showrooms.
Everything is crammed into a tiny space but it is a simple way to convey
the gist of a room design (read: the trading algorithm). However, they
are not built for practical use. Real strategies are like suites in an
apartment building. There is an underlying architectural commonality for
easy management and maintenance while enabling diversity in the
strategies. My recently completed software framework dramatically made
my life easier in the tasks of implementation and maintenance. Software
maintenance, in particular, is most often needlessly and overly
complicated in trading strategy development because of the lack of a
good design. Because at the end of the day, most programmers spend the
majority of their time debugging, maintaining, and extending their code.
A true object-oriented design decouples all its components so that you
can use a divide and conquer approach with no repetition of work. Do you
have a development process in place? I'd like to hear how you tackle
this problem.</p> </div>
            <div class="abbr published">
                Posted  <a href='http://www.quantisan.com/software-design-trading-development-process-and-ikea/' title='2011-04-12T07:30:00'>12 April 2011</a> in <a href="http://www.quantisan.com/category/algorithmic-trading/">algorithmic-trading</a>.              
            </div>
        </article>
        <article class='listed'>
            <h1 class="title">
                <a href="http://www.quantisan.com/more-trouble-with-jforex-iindicators/" rel='bookmark'>More trouble with JForex IIndicators</a>
            </h1>
            <div class="article-content"> <p>JFUtil offers [an elegant way of requesting indicators from the JForex
IIndicators interface][]. But the new design for JForex IIndicators
through JFUtil is only fixing one side of the problem. There is still
the question of what to do with the multiple return types from the
calculations. In JForex, indicators like RSI returns a one-dimensional
array. Other indicators like Stochastic Oscillator returns a
two-dimensional array. And some other ones return three or more
dimensional arrays. Java doesn't allow overloading a method with
multiple return types, as the program wouldn't know what to expect. So
how can we get rid of coding mess like this in our JForex strategy?
[java] Stochastic stochBean = IndicatorBeanFactory.getStochastic();
Object[] objs = Indicating.calculateMultiDimension(instrument,
Period.ONE_MIN, stochBean, 1); double[][] sto = new double[2][]; sto[0]
= (double[])objs[0]; // %K values sto[1] = (double[])objs[1]; // %D
values [/java] The default calculation method in JForex returns a
generic Object array. It's up to the programmer to know what to expect
from the call and cast the Object into something useful. Obviously, this
is a recipe for programming headaches and runtime errors. Having said
this, one of the biggest benefits of JForex is that it uses a standard
programming language like Java. So if there's something that you don't
like about the API, you can probably change it (e.g. Facade pattern).
This is the purpose of JFUtil to some extent, to <a href="http://www.quantisan.com/jfutil-an-open-source-jforex-utilities-library/">simplify the JForex
API behaviour</a>. In any case, I'm sure other Java programmers have
faced this problem before and have come up with good solutions for it. A
search on stackoverflow.com doesn't yield a quick fix solution at first
glimpse. My guess is that this require leveraging the knowledge about
the program structure. We know in advance what dimension of the
calculation result we can expect based on the indicator itself, perhaps
I can use something like a Command pattern to choose a calculation
sub-routine and then return a Map object with named values? I have yet
to try implementing this. I am open to design suggestions to encapsulate
multiple return values through a single interface. So that any indicator
bean can use the same calculation interface with an easy to use output.
In the mean time, getting multi-dimensional indicators results through
<a href="http://www.quantisan.com/jfutil-an-open-source-jforex-utilities-library/">JFUtil 2.1.2</a> isn't pretty.</p>
<p>[an elegant way of requesting indicators from the JForex IIndicators
  interface]: http://www.quantisan.com/conjuring-beans-to-simplify-jforex-iindicators/</p> </div>
            <div class="abbr published">
                Posted  <a href='http://www.quantisan.com/more-trouble-with-jforex-iindicators/' title='2011-03-29T07:36:00'>29 March 2011</a> in <a href="http://www.quantisan.com/category/algorithmic-trading/">algorithmic-trading</a>.              
            </div>
        </article>
        <article class='listed'>
            <h1 class="title">
                <a href="http://www.quantisan.com/conjuring-beans-to-simplify-jforex-iindicators/" rel='bookmark'>Conjuring beans to simplify JForex IIndicators</a>
            </h1>
            <div class="article-content"> <p>The JForex API is not perfect. Like any application programming
interface (API), some parts of the JForex API is better designed than
others. One of the most gripping problems with JForex is its use of
technical analysis (TA) indicators. Here's an example of using an
exponential moving average, one of the most simplest indicators.
<code>ema(instrument, Period.TEN_SECS, OfferSide.BID, IIndicators.AppliedPrice.MEDIAN_PRICE, 14, 0);</code>
And the corresponding javadoc explaining the parameters,
<code>Parameters: instrument instrument of the bar period period of the bar side bid or ask side of the bar appliedPrice type of input data timePeriod time period value shift number of candle back in time staring from current bar. 0 - current bar (currently generated from ticks), 1 - previous bar (last formed bar), 2 - current bar minus 2 bars and so on</code>
It's not intuitive but it's usable. Recall that in my <a href="http://www.quantisan.com/getting-started-learning-jforex-programming/">JForex
programming tutorial</a>, I suggested using the JForex API javadoc to
find out information about the API. However, for the case of
IIndicators, if you <a href="http://www.dukascopy.com/client/javadoc/com/dukascopy/api/IIndicators.html">take a look at its javadoc</a>, you will only be led
to more confusion by the hundred or so mysterious indicator methods with
cryptic parameter names. In JForex API, if you want to calculate an
indicator, you need to look through a long list of abbreviated method
names in the javadoc. Many of which are not easy to decipher. Secondly,
you need to figure out the generic parameters and set them correctly,
which is different for almost every indicator. Lastly, as there is no
standard interface for indicators, you need to hardcode these into your
strategy with little flexibility. In contrast, here's the same call
using <a href="http://www.quantisan.com/jfutil-an-open-source-jforex-utilities-library/">JFUtil 2.1.0</a> to get an EMA value. It has notably more lines of
code. It is designed deliberately so using an object oriented approach
by encapsulating the indicator parameters into a bean object and
abstracting the calculation into a single generic function call. [java]
// get an EMA indicator value by building an indicator bean
MovingAverage maBean = IndicatorBeanFactory.getMovingAverage(); // then
sets its parameters with obvious method names
maBean.setAppliedPrice(IIndicators.AppliedPrice.MEDIAN_PRICE)
.setMAType(IIndicators.MaType.EMA) .setWidth(14); // all of these are
optional parameters // feed the bean into a generic calculation method
to get the result double ema = Indicating.calculate(instrument,
Period.ONE_MIN, maBean); [/java] With JFUtil, to calculate an
indicator, you create an indicator bean with the intuitive bean name
that corresponds with the full name of an indicator. For example, a
moving average will be MovingAverage. Then you set the
indicator-specific parameters using clearly defined methods with useful
javadoc descriptions. One method for one parameter. Lastly, you feed
this indicator bean into a generic calculation function to get your
value. It took some thinking to abstract and generalize such a rigidly
structured API. I am quite pleased with this new design as the current
<a href="http://www.quantisan.com/jfutil-an-open-source-jforex-utilities-library/">JFUtil opens up a lot of design flexibility</a>. Such as
dynamic indicator selection with genetic algorithm and interchangeable
indicators use for runtime adaptive algorithms.</p> </div>
            <div class="abbr published">
                Posted  <a href='http://www.quantisan.com/conjuring-beans-to-simplify-jforex-iindicators/' title='2011-03-22T07:35:00'>22 March 2011</a> in <a href="http://www.quantisan.com/category/algorithmic-trading/">algorithmic-trading</a>.              
            </div>
        </article>
<p class="paginator">
</p>
    </section>

<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script type="text/javascript">
		try {
			var pageTracker = _gat._getTracker("UA-2047602-4");
			pageTracker._trackPageview();
		} catch(err) {}</script>
</body>
</html>